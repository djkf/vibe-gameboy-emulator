var $=Object.defineProperty;var U=(u,t,e)=>t in u?$(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var i=(u,t,e)=>U(u,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const h of r)if(h.type==="childList")for(const g of h.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&s(g)}).observe(document,{childList:!0,subtree:!0});function e(r){const h={};return r.integrity&&(h.integrity=r.integrity),r.referrerPolicy&&(h.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?h.credentials="include":r.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(r){if(r.ep)return;r.ep=!0;const h=e(r);fetch(r.href,h)}})();const w=0,R=1,B=2,D=3,I=4,T=5,P=6,a=7;class z{constructor(){i(this,"regs",new Uint8Array(8));i(this,"_PC",256);i(this,"_SP",65534);this.regs[w]=1,this.regs[R]=0,this.regs[B]=19,this.regs[D]=0,this.regs[I]=216,this.regs[T]=1,this.regs[P]=77,this.regs[a]=176}get A(){return this.regs[w]}set A(t){this.regs[w]=t&255}get B(){return this.regs[R]}set B(t){this.regs[R]=t&255}get C(){return this.regs[B]}set C(t){this.regs[B]=t&255}get D(){return this.regs[D]}set D(t){this.regs[D]=t&255}get E(){return this.regs[I]}set E(t){this.regs[I]=t&255}get H(){return this.regs[T]}set H(t){this.regs[T]=t&255}get L(){return this.regs[P]}set L(t){this.regs[P]=t&255}get F(){return this.regs[a]&240}set F(t){this.regs[a]=t&240}get flagZ(){return(this.regs[a]&128)!==0}set flagZ(t){this.regs[a]=t?this.regs[a]|128:this.regs[a]&-129}get flagN(){return(this.regs[a]&64)!==0}set flagN(t){this.regs[a]=t?this.regs[a]|64:this.regs[a]&-65}get flagH(){return(this.regs[a]&32)!==0}set flagH(t){this.regs[a]=t?this.regs[a]|32:this.regs[a]&-33}get flagC(){return(this.regs[a]&16)!==0}set flagC(t){this.regs[a]=t?this.regs[a]|16:this.regs[a]&-17}get BC(){return this.regs[R]<<8|this.regs[B]}set BC(t){this.regs[R]=t>>8&255,this.regs[B]=t&255}get DE(){return this.regs[D]<<8|this.regs[I]}set DE(t){this.regs[D]=t>>8&255,this.regs[I]=t&255}get HL(){return this.regs[T]<<8|this.regs[P]}set HL(t){this.regs[T]=t>>8&255,this.regs[P]=t&255}get AF(){return this.regs[w]<<8|this.F}set AF(t){this.regs[w]=t>>8&255,this.F=t&240}get PC(){return this._PC}set PC(t){this._PC=t&65535}get SP(){return this._SP}set SP(t){this._SP=t&65535}}const H=0,d=1,f=2,m=3,C=4,p=5,L=6;class X{constructor(t){i(this,"registers");i(this,"memory");i(this,"_totalCycles",0);i(this,"_isHalted",!1);i(this,"_interruptMasterEnable",!1);i(this,"_pendingEnableInterrupt",!1);i(this,"instructionTable");this.memory=t,this.registers=new z,this.instructionTable=this.createInstructionTable()}get totalCycles(){return this._totalCycles}get isHalted(){return this._isHalted}get interruptMasterEnable(){return this._interruptMasterEnable}checkInterrupts(){if(!this._interruptMasterEnable)return!1;const t=this.memory.read8(65535),e=this.memory.read8(65295),s=t&e;return s===0?!1:s&1?(this.handleInterrupt(64,0),!0):s&2?(this.handleInterrupt(72,1),!0):s&4?(this.handleInterrupt(80,2),!0):s&8?(this.handleInterrupt(88,3),!0):s&16?(this.handleInterrupt(96,4),!0):!1}handleInterrupt(t,e){const s=this.memory.read8(65295);this.memory.write8(65295,s&~(1<<e)),this._interruptMasterEnable=!1,this._isHalted=!1,this.pushStack16(this.registers.PC),this.registers.PC=t,this._totalCycles+=20}pushStack16(t){this.registers.SP=this.registers.SP-2&65535,this.memory.write16(this.registers.SP,t)}fetchInstruction(){const t=this.memory.read8(this.registers.PC);return this.registers.PC=this.registers.PC+1&65535,t}fetchImmediate8(){const t=this.memory.read8(this.registers.PC);return this.registers.PC=this.registers.PC+1&65535,t}fetchImmediate16(){const t=this.fetchImmediate8();return this.fetchImmediate8()<<8|t}step(){if(this._pendingEnableInterrupt&&(this._interruptMasterEnable=!0,this._pendingEnableInterrupt=!1),this.checkInterrupts())return;if(this._isHalted){this._totalCycles+=4;return}const t=this.memory.read8(this.registers.PC);this.registers.PC=this.registers.PC+1&65535;const e=this.instructionTable[t](t);this._totalCycles+=e}createInstructionTable(){const t=new Array(256);for(let e=0;e<256;e++)t[e]=s=>this.undefinedInstruction(s);return t[0]=()=>this.nop(),t[6]=()=>this.ld_B_n(),t[14]=()=>this.ld_C_n(),t[22]=()=>this.ld_D_n(),t[30]=()=>this.ld_E_n(),t[38]=()=>this.ld_H_n(),t[46]=()=>this.ld_L_n(),t[62]=()=>this.ld_A_n(),t[234]=()=>this.ld_nn_A(),t[1]=()=>this.ld_BC_nn(),t[17]=()=>this.ld_DE_nn(),t[33]=()=>this.ld_HL_nn(),t[49]=()=>this.ld_SP_nn(),t[195]=()=>this.jp_nn(),t[24]=()=>this.jr_n(),t[40]=()=>this.jr_Z_n(),t[32]=()=>this.jr_NZ_n(),t[48]=()=>this.jr_NC_n(),t[56]=()=>this.jr_C_n(),t[60]=()=>this.inc_A(),t[4]=()=>this.inc_B(),t[12]=()=>this.inc_C(),t[20]=()=>this.inc_D(),t[28]=()=>this.inc_E(),t[36]=()=>this.inc_H(),t[44]=()=>this.inc_L(),t[61]=()=>this.dec_A(),t[5]=()=>this.dec_B(),t[13]=()=>this.dec_C(),t[21]=()=>this.dec_D(),t[29]=()=>this.dec_E(),t[37]=()=>this.dec_H(),t[45]=()=>this.dec_L(),t[198]=()=>this.add_A_n(),t[254]=()=>this.cp_n(),t[197]=()=>this.push_BC(),t[213]=()=>this.push_DE(),t[229]=()=>this.push_HL(),t[245]=()=>this.push_AF(),t[193]=()=>this.pop_BC(),t[209]=()=>this.pop_DE(),t[225]=()=>this.pop_HL(),t[241]=()=>this.pop_AF(),t[205]=()=>this.call_nn(),t[201]=()=>this.ret(),t[203]=()=>this.executeCBInstruction(),t[64]=()=>this.ld_B_B(),t[65]=()=>this.ld_B_C(),t[66]=()=>this.ld_B_D(),t[67]=()=>this.ld_B_E(),t[68]=()=>this.ld_B_H(),t[69]=()=>this.ld_B_L(),t[70]=()=>this.ld_B_HL(),t[71]=()=>this.ld_B_A(),t[72]=()=>this.ld_C_B(),t[73]=()=>this.ld_C_C(),t[74]=()=>this.ld_C_D(),t[75]=()=>this.ld_C_E(),t[76]=()=>this.ld_C_H(),t[77]=()=>this.ld_C_L(),t[78]=()=>this.ld_C_HL(),t[79]=()=>this.ld_C_A(),t[80]=()=>this.ld_D_B(),t[81]=()=>this.ld_D_C(),t[82]=()=>this.ld_D_D(),t[83]=()=>this.ld_D_E(),t[84]=()=>this.ld_D_H(),t[85]=()=>this.ld_D_L(),t[86]=()=>this.ld_D_HL(),t[87]=()=>this.ld_D_A(),t[88]=()=>this.ld_E_B(),t[89]=()=>this.ld_E_C(),t[90]=()=>this.ld_E_D(),t[91]=()=>this.ld_E_E(),t[92]=()=>this.ld_E_H(),t[93]=()=>this.ld_E_L(),t[94]=()=>this.ld_E_HL(),t[95]=()=>this.ld_E_A(),t[96]=()=>this.ld_H_B(),t[97]=()=>this.ld_H_C(),t[98]=()=>this.ld_H_D(),t[99]=()=>this.ld_H_E(),t[100]=()=>this.ld_H_H(),t[101]=()=>this.ld_H_L(),t[102]=()=>this.ld_H_HL(),t[103]=()=>this.ld_H_A(),t[104]=()=>this.ld_L_B(),t[105]=()=>this.ld_L_C(),t[106]=()=>this.ld_L_D(),t[107]=()=>this.ld_L_E(),t[108]=()=>this.ld_L_H(),t[109]=()=>this.ld_L_L(),t[110]=()=>this.ld_L_HL(),t[111]=()=>this.ld_L_A(),t[112]=()=>this.ld_HL_B(),t[113]=()=>this.ld_HL_C(),t[114]=()=>this.ld_HL_D(),t[115]=()=>this.ld_HL_E(),t[116]=()=>this.ld_HL_H(),t[117]=()=>this.ld_HL_L(),t[118]=()=>this.halt(),t[119]=()=>this.ld_HL_A(),t[120]=()=>this.ld_A_B(),t[121]=()=>this.ld_A_C(),t[122]=()=>this.ld_A_D(),t[123]=()=>this.ld_A_E(),t[124]=()=>this.ld_A_H(),t[125]=()=>this.ld_A_L(),t[126]=()=>this.ld_A_HL(),t[127]=()=>this.ld_A_A(),t[128]=()=>this.add_A_B(),t[129]=()=>this.add_A_C(),t[130]=()=>this.add_A_D(),t[131]=()=>this.add_A_E(),t[132]=()=>this.add_A_H(),t[133]=()=>this.add_A_L(),t[134]=()=>this.add_A_HL(),t[135]=()=>this.add_A_A(),t[144]=()=>this.sub_B(),t[145]=()=>this.sub_C(),t[146]=()=>this.sub_D(),t[147]=()=>this.sub_E(),t[148]=()=>this.sub_H(),t[149]=()=>this.sub_L(),t[150]=()=>this.sub_HL(),t[151]=()=>this.sub_A(),t[160]=()=>this.and_B(),t[161]=()=>this.and_C(),t[162]=()=>this.and_D(),t[163]=()=>this.and_E(),t[164]=()=>this.and_H(),t[165]=()=>this.and_L(),t[166]=()=>this.and_HL(),t[167]=()=>this.and_A(),t[176]=()=>this.or_B(),t[177]=()=>this.or_C(),t[178]=()=>this.or_D(),t[179]=()=>this.or_E(),t[180]=()=>this.or_H(),t[181]=()=>this.or_L(),t[182]=()=>this.or_HL(),t[183]=()=>this.or_A(),t[184]=()=>this.cp_B(),t[185]=()=>this.cp_C(),t[186]=()=>this.cp_D(),t[187]=()=>this.cp_E(),t[188]=()=>this.cp_H(),t[189]=()=>this.cp_L(),t[190]=()=>this.cp_HL(),t[2]=()=>this.ld_BC_A(),t[10]=()=>this.ld_A_BC(),t[18]=()=>this.ld_DE_A(),t[26]=()=>this.ld_A_DE(),t[34]=()=>this.ld_HLI_A(),t[42]=()=>this.ld_A_HLI(),t[50]=()=>this.ld_HLD_A(),t[58]=()=>this.ld_A_HLD(),t[54]=()=>this.ld_HL_n(),t[224]=()=>this.ldh_n_A(),t[226]=()=>this.ld_FF00_C_A(),t[240]=()=>this.ldh_A_n(),t[242]=()=>this.ld_A_FF00_C(),t[250]=()=>this.ld_A_nn(),t[3]=()=>this.inc_BC(),t[19]=()=>this.inc_DE(),t[35]=()=>this.inc_HL(),t[51]=()=>this.inc_SP(),t[11]=()=>this.dec_BC(),t[27]=()=>this.dec_DE(),t[43]=()=>this.dec_HL(),t[59]=()=>this.dec_SP(),t[9]=()=>this.add_HL_BC(),t[25]=()=>this.add_HL_DE(),t[41]=()=>this.add_HL_HL(),t[57]=()=>this.add_HL_SP(),t[52]=()=>this.inc_HL_addr(),t[53]=()=>this.dec_HL_addr(),t[7]=()=>this.rlca(),t[15]=()=>this.rrca(),t[23]=()=>this.rla(),t[31]=()=>this.rra(),t[47]=()=>this.cpl(),t[55]=()=>this.scf(),t[63]=()=>this.ccf(),t[39]=()=>this.daa(),t[243]=()=>this.di(),t[251]=()=>this.ei(),t[230]=()=>this.and_n(),t[238]=()=>this.xor_n(),t[246]=()=>this.or_n(),t[214]=()=>this.sub_n(),t[248]=()=>this.ld_HL_SP_n(),t[249]=()=>this.ld_SP_HL(),t[232]=()=>this.add_SP_n(),t[233]=()=>this.jp_HL(),t[192]=()=>this.ret_NZ(),t[200]=()=>this.ret_Z(),t[208]=()=>this.ret_NC(),t[216]=()=>this.ret_C(),t[217]=()=>this.reti(),t[194]=()=>this.jp_NZ_nn(),t[202]=()=>this.jp_Z_nn(),t[210]=()=>this.jp_NC_nn(),t[218]=()=>this.jp_C_nn(),t[196]=()=>this.call_NZ_nn(),t[204]=()=>this.call_Z_nn(),t[212]=()=>this.call_NC_nn(),t[220]=()=>this.call_C_nn(),t[168]=()=>this.xor_B(),t[169]=()=>this.xor_C(),t[170]=()=>this.xor_D(),t[171]=()=>this.xor_E(),t[172]=()=>this.xor_H(),t[173]=()=>this.xor_L(),t[174]=()=>this.xor_HL(),t[175]=()=>this.xor_A(),t[136]=()=>this.adc_B(),t[137]=()=>this.adc_C(),t[138]=()=>this.adc_D(),t[139]=()=>this.adc_E(),t[140]=()=>this.adc_H(),t[141]=()=>this.adc_L(),t[142]=()=>this.adc_HL(),t[143]=()=>this.adc_A(),t[152]=()=>this.sbc_B(),t[153]=()=>this.sbc_C(),t[154]=()=>this.sbc_D(),t[155]=()=>this.sbc_E(),t[156]=()=>this.sbc_H(),t[157]=()=>this.sbc_L(),t[158]=()=>this.sbc_HL(),t[159]=()=>this.sbc_A(),t[206]=()=>this.adc_n(),t[222]=()=>this.sbc_n(),t[199]=()=>this.rst_00(),t[207]=()=>this.rst_08(),t[215]=()=>this.rst_10(),t[223]=()=>this.rst_18(),t[231]=()=>this.rst_20(),t[239]=()=>this.rst_28(),t[247]=()=>this.rst_30(),t[255]=()=>this.rst_38(),t[8]=()=>this.ld_nn_SP(),t[16]=()=>this.stop(),t[243]=()=>this.di(),t[251]=()=>this.ei(),t}nop(){return 4}undefinedInstruction(t){throw new Error("Undefined instruction: 0x"+t.toString(16).padStart(2,"0"))}ld_B_n(){return this.registers.regs[d]=this.fetchImmediate8(),8}ld_C_n(){return this.registers.regs[f]=this.fetchImmediate8(),8}ld_D_n(){return this.registers.regs[m]=this.fetchImmediate8(),8}ld_E_n(){return this.registers.regs[C]=this.fetchImmediate8(),8}ld_H_n(){return this.registers.regs[p]=this.fetchImmediate8(),8}ld_L_n(){return this.registers.regs[L]=this.fetchImmediate8(),8}ld_A_n(){return this.registers.regs[H]=this.fetchImmediate8(),8}ld_B_B(){return this.registers.regs[d]=this.registers.regs[d],4}ld_B_C(){return this.registers.regs[d]=this.registers.regs[f],4}ld_B_D(){return this.registers.regs[d]=this.registers.regs[m],4}ld_B_E(){return this.registers.regs[d]=this.registers.regs[C],4}ld_B_H(){return this.registers.regs[d]=this.registers.regs[p],4}ld_B_L(){return this.registers.regs[d]=this.registers.regs[L],4}ld_B_HL(){return this.registers.regs[d]=this.memory.read8(this.registers.HL),8}ld_B_A(){return this.registers.regs[d]=this.registers.regs[H],4}ld_C_B(){return this.registers.regs[f]=this.registers.regs[d],4}ld_C_C(){return this.registers.regs[f]=this.registers.regs[f],4}ld_C_D(){return this.registers.regs[f]=this.registers.regs[m],4}ld_C_E(){return this.registers.regs[f]=this.registers.regs[C],4}ld_C_H(){return this.registers.regs[f]=this.registers.regs[p],4}ld_C_L(){return this.registers.regs[f]=this.registers.regs[L],4}ld_C_HL(){return this.registers.regs[f]=this.memory.read8(this.registers.HL),8}ld_C_A(){return this.registers.regs[f]=this.registers.regs[H],4}ld_D_B(){return this.registers.regs[m]=this.registers.regs[d],4}ld_D_C(){return this.registers.regs[m]=this.registers.regs[f],4}ld_D_D(){return this.registers.regs[m]=this.registers.regs[m],4}ld_D_E(){return this.registers.regs[m]=this.registers.regs[C],4}ld_D_H(){return this.registers.regs[m]=this.registers.regs[p],4}ld_D_L(){return this.registers.regs[m]=this.registers.regs[L],4}ld_D_HL(){return this.registers.regs[m]=this.memory.read8(this.registers.HL),8}ld_D_A(){return this.registers.regs[m]=this.registers.regs[H],4}ld_E_B(){return this.registers.regs[C]=this.registers.regs[d],4}ld_E_C(){return this.registers.regs[C]=this.registers.regs[f],4}ld_E_D(){return this.registers.regs[C]=this.registers.regs[m],4}ld_E_E(){return this.registers.regs[C]=this.registers.regs[C],4}ld_E_H(){return this.registers.regs[C]=this.registers.regs[p],4}ld_E_L(){return this.registers.regs[C]=this.registers.regs[L],4}ld_E_HL(){return this.registers.regs[C]=this.memory.read8(this.registers.HL),8}ld_E_A(){return this.registers.regs[C]=this.registers.regs[H],4}ld_H_B(){return this.registers.regs[p]=this.registers.regs[d],4}ld_H_C(){return this.registers.regs[p]=this.registers.regs[f],4}ld_H_D(){return this.registers.regs[p]=this.registers.regs[m],4}ld_H_E(){return this.registers.regs[p]=this.registers.regs[C],4}ld_H_H(){return this.registers.regs[p]=this.registers.regs[p],4}ld_H_L(){return this.registers.regs[p]=this.registers.regs[L],4}ld_H_HL(){return this.registers.regs[p]=this.memory.read8(this.registers.HL),8}ld_H_A(){return this.registers.regs[p]=this.registers.regs[H],4}ld_L_B(){return this.registers.regs[L]=this.registers.regs[d],4}ld_L_C(){return this.registers.regs[L]=this.registers.regs[f],4}ld_L_D(){return this.registers.regs[L]=this.registers.regs[m],4}ld_L_E(){return this.registers.regs[L]=this.registers.regs[C],4}ld_L_H(){return this.registers.regs[L]=this.registers.regs[p],4}ld_L_L(){return this.registers.regs[L]=this.registers.regs[L],4}ld_L_HL(){return this.registers.regs[L]=this.memory.read8(this.registers.HL),8}ld_L_A(){return this.registers.regs[L]=this.registers.regs[H],4}ld_A_B(){return this.registers.regs[H]=this.registers.regs[d],4}ld_A_C(){return this.registers.regs[H]=this.registers.regs[f],4}ld_A_D(){return this.registers.regs[H]=this.registers.regs[m],4}ld_A_E(){return this.registers.regs[H]=this.registers.regs[C],4}ld_A_H(){return this.registers.regs[H]=this.registers.regs[p],4}ld_A_L(){return this.registers.regs[H]=this.registers.regs[L],4}ld_A_A(){return this.registers.regs[H]=this.registers.regs[H],4}ld_A_HL(){return this.registers.A=this.memory.read8(this.registers.HL),8}ld_HL_A(){return this.memory.write8(this.registers.HL,this.registers.A),8}ld_nn_A(){const t=this.fetchImmediate16();return this.memory.write8(t,this.registers.A),16}ld_BC_nn(){return this.registers.BC=this.fetchImmediate16(),12}ld_DE_nn(){return this.registers.DE=this.fetchImmediate16(),12}ld_HL_nn(){return this.registers.HL=this.fetchImmediate16(),12}ld_SP_nn(){return this.registers.SP=this.fetchImmediate16(),12}jp_nn(){return this.registers.PC=this.fetchImmediate16(),16}jr_n(){const t=this.fetchImmediate8(),e=t>127?t-256:t;return this.registers.PC=this.registers.PC+e&65535,12}jr_Z_n(){const t=this.fetchImmediate8();if(this.registers.flagZ){const e=t>127?t-256:t;return this.registers.PC=this.registers.PC+e&65535,12}return 8}jr_NZ_n(){const t=this.fetchImmediate8();if(!this.registers.flagZ){const e=t>127?t-256:t;return this.registers.PC=this.registers.PC+e&65535,12}return 8}jr_NC_n(){const t=this.fetchImmediate8();if(!this.registers.flagC){const e=t>127?t-256:t;return this.registers.PC=this.registers.PC+e&65535,12}return 8}jr_C_n(){const t=this.fetchImmediate8();if(this.registers.flagC){const e=t>127?t-256:t;return this.registers.PC=this.registers.PC+e&65535,12}return 8}inc_A(){return this.inc8bit("A")}inc_B(){return this.inc8bit("B")}inc_C(){return this.inc8bit("C")}inc_D(){return this.inc8bit("D")}inc_E(){return this.inc8bit("E")}inc_H(){return this.inc8bit("H")}inc_L(){return this.inc8bit("L")}dec_A(){return this.dec8bit("A")}dec_B(){return this.dec8bit("B")}dec_C(){return this.dec8bit("C")}dec_D(){return this.dec8bit("D")}dec_E(){return this.dec8bit("E")}dec_H(){return this.dec8bit("H")}dec_L(){return this.dec8bit("L")}inc8bit(t){const e=this.registers[t],s=e+1&255;return this.registers[t]=s,this.registers.flagZ=s===0,this.registers.flagN=!1,this.registers.flagH=(e&15)===15,4}dec8bit(t){const e=this.registers[t],s=e-1&255;return this.registers[t]=s,this.registers.flagZ=s===0,this.registers.flagN=!0,this.registers.flagH=(e&15)===0,4}add_A_n(){const t=this.fetchImmediate8(),e=this.registers.A+t;return this.registers.flagZ=(e&255)===0,this.registers.flagN=!1,this.registers.flagH=(this.registers.A&15)+(t&15)>15,this.registers.flagC=e>255,this.registers.A=e&255,8}cp_n(){const t=this.fetchImmediate8(),e=this.registers.A-t;return this.registers.flagZ=(e&255)===0,this.registers.flagN=!0,this.registers.flagH=(this.registers.A&15)<(t&15),this.registers.flagC=e<0,8}push_BC(){return this.pushStack(this.registers.BC),16}push_DE(){return this.pushStack(this.registers.DE),16}push_HL(){return this.pushStack(this.registers.HL),16}push_AF(){return this.pushStack(this.registers.AF),16}pop_BC(){return this.registers.BC=this.popStack(),12}pop_DE(){return this.registers.DE=this.popStack(),12}pop_HL(){return this.registers.HL=this.popStack(),12}pop_AF(){return this.registers.AF=this.popStack(),12}pushStack(t){this.registers.SP=this.registers.SP-2&65535,this.memory.write16(this.registers.SP,t)}popStack(){const t=this.memory.read16(this.registers.SP);return this.registers.SP=this.registers.SP+2&65535,t}call_nn(){const t=this.fetchImmediate16();return this.pushStack(this.registers.PC),this.registers.PC=t,24}ret(){return this.registers.PC=this.popStack(),16}reti(){return this.registers.PC=this.popStack(),this._interruptMasterEnable=!0,this._pendingEnableInterrupt=!1,16}halt(){return this._isHalted=!0,4}ld_BC_A(){return this.memory.write8(this.registers.BC,this.registers.A),8}ld_A_BC(){return this.registers.A=this.memory.read8(this.registers.BC),8}ld_DE_A(){return this.memory.write8(this.registers.DE,this.registers.A),8}ld_A_DE(){return this.registers.A=this.memory.read8(this.registers.DE),8}ld_HLI_A(){return this.memory.write8(this.registers.HL,this.registers.A),this.registers.HL=this.registers.HL+1&65535,8}ld_A_HLI(){return this.registers.A=this.memory.read8(this.registers.HL),this.registers.HL=this.registers.HL+1&65535,8}ld_HLD_A(){return this.memory.write8(this.registers.HL,this.registers.A),this.registers.HL=this.registers.HL-1&65535,8}ld_A_HLD(){return this.registers.A=this.memory.read8(this.registers.HL),this.registers.HL=this.registers.HL-1&65535,8}ld_HL_n(){const t=this.fetchImmediate8();return this.memory.write8(this.registers.HL,t),12}ld_A_nn(){const t=this.fetchImmediate16();return this.registers.A=this.memory.read8(t),16}ldh_n_A(){const t=this.fetchImmediate8();return this.memory.write8(65280+t,this.registers.A),12}ldh_A_n(){const t=this.fetchImmediate8();return this.registers.A=this.memory.read8(65280+t),12}add_A_C(){return this.addToA(this.registers.C)}add_A_D(){return this.addToA(this.registers.D)}add_A_E(){return this.addToA(this.registers.E)}add_A_H(){return this.addToA(this.registers.H)}add_A_L(){return this.addToA(this.registers.L)}add_A_HL(){return this.addToA(this.memory.read8(this.registers.HL),8)}add_A_A(){return this.addToA(this.registers.A)}add_A_B(){return this.addToA(this.registers.B)}addToA(t,e=4){const s=this.registers.A+t;return this.registers.flagZ=(s&255)===0,this.registers.flagN=!1,this.registers.flagH=(this.registers.A&15)+(t&15)>15,this.registers.flagC=s>255,this.registers.A=s&255,e}sub_B(){return this.subFromA(this.registers.B)}sub_C(){return this.subFromA(this.registers.C)}sub_D(){return this.subFromA(this.registers.D)}sub_E(){return this.subFromA(this.registers.E)}sub_H(){return this.subFromA(this.registers.H)}sub_L(){return this.subFromA(this.registers.L)}sub_HL(){return this.subFromA(this.memory.read8(this.registers.HL),8)}sub_A(){return this.subFromA(this.registers.A)}subFromA(t,e=4){const s=this.registers.A-t;return this.registers.flagZ=(s&255)===0,this.registers.flagN=!0,this.registers.flagH=(this.registers.A&15)<(t&15),this.registers.flagC=s<0,this.registers.A=s&255,e}and_B(){return this.andWithA(this.registers.B)}and_C(){return this.andWithA(this.registers.C)}and_D(){return this.andWithA(this.registers.D)}and_E(){return this.andWithA(this.registers.E)}and_H(){return this.andWithA(this.registers.H)}and_L(){return this.andWithA(this.registers.L)}and_HL(){return this.andWithA(this.memory.read8(this.registers.HL),8)}and_A(){return this.andWithA(this.registers.A)}andWithA(t,e=4){return this.registers.A&=t,this.registers.flagZ=this.registers.A===0,this.registers.flagN=!1,this.registers.flagH=!0,this.registers.flagC=!1,e}or_B(){return this.orWithA(this.registers.B)}or_C(){return this.orWithA(this.registers.C)}or_D(){return this.orWithA(this.registers.D)}or_E(){return this.orWithA(this.registers.E)}or_H(){return this.orWithA(this.registers.H)}or_L(){return this.orWithA(this.registers.L)}or_HL(){return this.orWithA(this.memory.read8(this.registers.HL),8)}or_A(){return this.orWithA(this.registers.A)}orWithA(t,e=4){return this.registers.A|=t,this.registers.flagZ=this.registers.A===0,this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=!1,e}xor_B(){return this.xorWithA(this.registers.B)}xor_C(){return this.xorWithA(this.registers.C)}xor_D(){return this.xorWithA(this.registers.D)}xor_E(){return this.xorWithA(this.registers.E)}xor_H(){return this.xorWithA(this.registers.H)}xor_L(){return this.xorWithA(this.registers.L)}xor_HL(){return this.xorWithA(this.memory.read8(this.registers.HL),8)}xor_A(){return this.xorWithA(this.registers.A)}xorWithA(t,e=4){return this.registers.A^=t,this.registers.flagZ=this.registers.A===0,this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=!1,e}cp_B(){return this.compareWithA(this.registers.B)}cp_C(){return this.compareWithA(this.registers.C)}cp_D(){return this.compareWithA(this.registers.D)}cp_E(){return this.compareWithA(this.registers.E)}cp_H(){return this.compareWithA(this.registers.H)}cp_L(){return this.compareWithA(this.registers.L)}cp_HL(){return this.compareWithA(this.memory.read8(this.registers.HL),8)}compareWithA(t,e=4){const s=this.registers.A-t;return this.registers.flagZ=(s&255)===0,this.registers.flagN=!0,this.registers.flagH=(this.registers.A&15)<(t&15),this.registers.flagC=s<0,e}inc_BC(){return this.registers.BC=this.registers.BC+1&65535,8}inc_DE(){return this.registers.DE=this.registers.DE+1&65535,8}inc_HL(){return this.registers.HL=this.registers.HL+1&65535,8}inc_SP(){return this.registers.SP=this.registers.SP+1&65535,8}dec_BC(){return this.registers.BC=this.registers.BC-1&65535,8}dec_DE(){return this.registers.DE=this.registers.DE-1&65535,8}dec_HL(){return this.registers.HL=this.registers.HL-1&65535,8}dec_SP(){return this.registers.SP=this.registers.SP-1&65535,8}add_HL_BC(){return this.add16ToHL(this.registers.BC)}add_HL_DE(){return this.add16ToHL(this.registers.DE)}add_HL_HL(){return this.add16ToHL(this.registers.HL)}add_HL_SP(){return this.add16ToHL(this.registers.SP)}add16ToHL(t){const e=this.registers.HL+t;return this.registers.flagN=!1,this.registers.flagH=(this.registers.HL&4095)+(t&4095)>4095,this.registers.flagC=e>65535,this.registers.HL=e&65535,8}inc_HL_addr(){const t=this.memory.read8(this.registers.HL),e=t+1&255;return this.memory.write8(this.registers.HL,e),this.registers.flagZ=e===0,this.registers.flagN=!1,this.registers.flagH=(t&15)===15,12}dec_HL_addr(){const t=this.memory.read8(this.registers.HL),e=t-1&255;return this.memory.write8(this.registers.HL,e),this.registers.flagZ=e===0,this.registers.flagN=!0,this.registers.flagH=(t&15)===0,12}rlca(){const t=(this.registers.A&128)>>7;return this.registers.A=(this.registers.A<<1|t)&255,this.registers.flagZ=!1,this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=t===1,4}rrca(){const t=this.registers.A&1;return this.registers.A=(this.registers.A>>1|t<<7)&255,this.registers.flagZ=!1,this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=t===1,4}rla(){const t=this.registers.flagC?1:0,e=(this.registers.A&128)>>7;return this.registers.A=(this.registers.A<<1|t)&255,this.registers.flagZ=!1,this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=e===1,4}rra(){const t=this.registers.flagC?1:0,e=this.registers.A&1;return this.registers.A=(this.registers.A>>1|t<<7)&255,this.registers.flagZ=!1,this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=e===1,4}cpl(){return this.registers.A=~this.registers.A&255,this.registers.flagN=!0,this.registers.flagH=!0,4}scf(){return this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=!0,4}ccf(){return this.registers.flagN=!1,this.registers.flagH=!1,this.registers.flagC=!this.registers.flagC,4}daa(){let t=0,e=!1;return(this.registers.flagH||!this.registers.flagN&&(this.registers.A&15)>9)&&(t+=6),(this.registers.flagC||!this.registers.flagN&&this.registers.A>153)&&(t+=96,e=!0),this.registers.flagN?this.registers.A=this.registers.A-t&255:this.registers.A=this.registers.A+t&255,this.registers.flagZ=this.registers.A===0,this.registers.flagH=!1,this.registers.flagC=e,4}di(){return this._interruptMasterEnable=!1,this._pendingEnableInterrupt=!1,4}ei(){return this._pendingEnableInterrupt=!0,4}and_n(){const t=this.fetchImmediate8();return this.andWithA(t,8)}xor_n(){const t=this.fetchImmediate8();return this.xorWithA(t,8)}or_n(){const t=this.fetchImmediate8();return this.orWithA(t,8)}sub_n(){const t=this.fetchImmediate8();return this.subFromA(t,8)}ld_HL_SP_n(){const t=this.fetchImmediate8(),e=t>127?t-256:t,s=this.registers.SP+e;return this.registers.flagZ=!1,this.registers.flagN=!1,this.registers.flagH=(this.registers.SP&15)+(t&15)>15,this.registers.flagC=(this.registers.SP&255)+t>255,this.registers.HL=s&65535,12}ld_SP_HL(){return this.registers.SP=this.registers.HL,8}add_SP_n(){const t=this.fetchImmediate8(),e=t>127?t-256:t;return this.registers.flagZ=!1,this.registers.flagN=!1,this.registers.flagH=(this.registers.SP&15)+(t&15)>15,this.registers.flagC=(this.registers.SP&255)+t>255,this.registers.SP=this.registers.SP+e&65535,16}jp_HL(){return this.registers.PC=this.registers.HL,4}ret_NZ(){return this.registers.flagZ?8:(this.registers.PC=this.popStack(),20)}ret_Z(){return this.registers.flagZ?(this.registers.PC=this.popStack(),20):8}ret_NC(){return this.registers.flagC?8:(this.registers.PC=this.popStack(),20)}ret_C(){return this.registers.flagC?(this.registers.PC=this.popStack(),20):8}jp_NZ_nn(){const t=this.fetchImmediate16();return this.registers.flagZ?12:(this.registers.PC=t,16)}jp_Z_nn(){const t=this.fetchImmediate16();return this.registers.flagZ?(this.registers.PC=t,16):12}jp_NC_nn(){const t=this.fetchImmediate16();return this.registers.flagC?12:(this.registers.PC=t,16)}jp_C_nn(){const t=this.fetchImmediate16();return this.registers.flagC?(this.registers.PC=t,16):12}call_NZ_nn(){const t=this.fetchImmediate16();return this.registers.flagZ?12:(this.pushStack(this.registers.PC),this.registers.PC=t,24)}call_Z_nn(){const t=this.fetchImmediate16();return this.registers.flagZ?(this.pushStack(this.registers.PC),this.registers.PC=t,24):12}call_NC_nn(){const t=this.fetchImmediate16();return this.registers.flagC?12:(this.pushStack(this.registers.PC),this.registers.PC=t,24)}call_C_nn(){const t=this.fetchImmediate16();return this.registers.flagC?(this.pushStack(this.registers.PC),this.registers.PC=t,24):12}adc_B(){return this.adcToA(this.registers.B)}adc_C(){return this.adcToA(this.registers.C)}adc_D(){return this.adcToA(this.registers.D)}adc_E(){return this.adcToA(this.registers.E)}adc_H(){return this.adcToA(this.registers.H)}adc_L(){return this.adcToA(this.registers.L)}adc_HL(){return this.adcToA(this.memory.read8(this.registers.HL),8)}adc_A(){return this.adcToA(this.registers.A)}adcToA(t,e=4){const s=this.registers.flagC?1:0,r=this.registers.A+t+s;return this.registers.flagZ=(r&255)===0,this.registers.flagN=!1,this.registers.flagH=(this.registers.A&15)+(t&15)+s>15,this.registers.flagC=r>255,this.registers.A=r&255,e}sbc_B(){return this.sbcFromA(this.registers.B)}sbc_C(){return this.sbcFromA(this.registers.C)}sbc_D(){return this.sbcFromA(this.registers.D)}sbc_E(){return this.sbcFromA(this.registers.E)}sbc_H(){return this.sbcFromA(this.registers.H)}sbc_L(){return this.sbcFromA(this.registers.L)}sbc_HL(){return this.sbcFromA(this.memory.read8(this.registers.HL),8)}sbc_A(){return this.sbcFromA(this.registers.A)}sbcFromA(t,e=4){const s=this.registers.flagC?1:0,r=this.registers.A-t-s;return this.registers.flagZ=(r&255)===0,this.registers.flagN=!0,this.registers.flagH=(this.registers.A&15)<(t&15)+s,this.registers.flagC=r<0,this.registers.A=r&255,e}adc_n(){const t=this.fetchImmediate8();return this.adcToA(t,8)}sbc_n(){const t=this.fetchImmediate8();return this.sbcFromA(t,8)}rst_00(){return this.pushStack(this.registers.PC),this.registers.PC=0,16}rst_08(){return this.pushStack(this.registers.PC),this.registers.PC=8,16}rst_10(){return this.pushStack(this.registers.PC),this.registers.PC=16,16}rst_18(){return this.pushStack(this.registers.PC),this.registers.PC=24,16}rst_20(){return this.pushStack(this.registers.PC),this.registers.PC=32,16}rst_28(){return this.pushStack(this.registers.PC),this.registers.PC=40,16}rst_30(){return this.pushStack(this.registers.PC),this.registers.PC=48,16}rst_38(){return this.pushStack(this.registers.PC),this.registers.PC=56,16}ld_nn_SP(){const t=this.fetchImmediate16();return this.memory.write16(t,this.registers.SP),20}stop(){return this._isHalted=!0,4}ld_HL_B(){return this.memory.write8(this.registers.HL,this.registers.B),8}ld_HL_C(){return this.memory.write8(this.registers.HL,this.registers.C),8}ld_HL_D(){return this.memory.write8(this.registers.HL,this.registers.D),8}ld_HL_E(){return this.memory.write8(this.registers.HL,this.registers.E),8}ld_HL_H(){return this.memory.write8(this.registers.HL,this.registers.H),8}ld_HL_L(){return this.memory.write8(this.registers.HL,this.registers.L),8}ld_FF00_C_A(){return this.memory.write8(65280+this.registers.C,this.registers.A),8}ld_A_FF00_C(){return this.registers.A=this.memory.read8(65280+this.registers.C),8}executeCBInstruction(){const t=this.fetchImmediate8(),e=t>>6&3,s=t>>3&7,r=t&7;switch(e){case 0:return this.executeCBShiftRotate(t,s,r);case 1:return this.executeCBBit(s,r);case 2:return this.executeCBRes(s,r);case 3:return this.executeCBSet(s,r);default:throw new Error(`Unknown CB operation: 0x${t.toString(16).padStart(2,"0")}`)}}executeCBShiftRotate(t,e,s){let r=this.getCBRegisterValue(s),h=0,g=s===6?16:8;switch(e){case 0:h=(r<<1|r>>7)&255,this.registers.flagC=(r&128)!==0;break;case 1:h=(r>>1|r<<7)&255,this.registers.flagC=(r&1)!==0;break;case 2:h=(r<<1|(this.registers.flagC?1:0))&255,this.registers.flagC=(r&128)!==0;break;case 3:h=(r>>1|(this.registers.flagC?128:0))&255,this.registers.flagC=(r&1)!==0;break;case 4:h=r<<1&255,this.registers.flagC=(r&128)!==0;break;case 5:h=(r>>1|r&128)&255,this.registers.flagC=(r&1)!==0;break;case 6:h=(r<<4|r>>4)&255,this.registers.flagC=!1;break;case 7:h=r>>1&255,this.registers.flagC=(r&1)!==0;break;default:throw new Error(`Unknown CB shift/rotate: 0x${t.toString(16).padStart(2,"0")}`)}return this.registers.flagZ=h===0,this.registers.flagN=!1,this.registers.flagH=!1,this.setCBRegisterValue(s,h),g}executeCBBit(t,e){const r=(this.getCBRegisterValue(e)&1<<t)!==0;return this.registers.flagZ=!r,this.registers.flagN=!1,this.registers.flagH=!0,e===6?12:8}executeCBRes(t,e){const r=this.getCBRegisterValue(e)&~(1<<t);return this.setCBRegisterValue(e,r),e===6?16:8}executeCBSet(t,e){const r=this.getCBRegisterValue(e)|1<<t;return this.setCBRegisterValue(e,r),e===6?16:8}getCBRegisterValue(t){switch(t){case 0:return this.registers.B;case 1:return this.registers.C;case 2:return this.registers.D;case 3:return this.registers.E;case 4:return this.registers.H;case 5:return this.registers.L;case 6:return this.memory.read8(this.registers.HL);case 7:return this.registers.A;default:throw new Error(`Invalid CB register: ${t}`)}}setCBRegisterValue(t,e){switch(t){case 0:this.registers.B=e;break;case 1:this.registers.C=e;break;case 2:this.registers.D=e;break;case 3:this.registers.E=e;break;case 4:this.registers.H=e;break;case 5:this.registers.L=e;break;case 6:this.memory.write8(this.registers.HL,e);break;case 7:this.registers.A=e;break;default:throw new Error(`Invalid CB register: ${t}`)}}}class K{constructor(){i(this,"buttonA",!1);i(this,"buttonB",!1);i(this,"buttonSelect",!1);i(this,"buttonStart",!1);i(this,"directionUp",!1);i(this,"directionDown",!1);i(this,"directionLeft",!1);i(this,"directionRight",!1);i(this,"p1Register",255)}setButton(t,e){switch(t){case"A":this.buttonA=e;break;case"B":this.buttonB=e;break;case"Select":this.buttonSelect=e;break;case"Start":this.buttonStart=e;break;case"Up":this.directionUp=e;break;case"Down":this.directionDown=e;break;case"Left":this.directionLeft=e;break;case"Right":this.directionRight=e;break}}writeP1(t){this.p1Register=this.p1Register&15|t&48}readP1(){let t=this.p1Register&240;const e=(this.p1Register&32)===0,s=(this.p1Register&16)===0;let r=15;return e?(this.buttonA&&(r&=-2),this.buttonB&&(r&=-3),this.buttonSelect&&(r&=-5),this.buttonStart&&(r&=-9)):s&&(this.directionRight&&(r&=-2),this.directionLeft&&(r&=-3),this.directionUp&&(r&=-5),this.directionDown&&(r&=-9)),t|r}}class J{constructor(){i(this,"rom",new Uint8Array(32768));i(this,"vram",new Uint8Array(8192));i(this,"extRam",new Uint8Array(8192));i(this,"workRam",new Uint8Array(8192));i(this,"oam",new Uint8Array(160));i(this,"ioRegisters",new Uint8Array(128));i(this,"highRam",new Uint8Array(127));i(this,"interruptEnable",0);i(this,"joypad",new K);i(this,"dividerCounter",0);i(this,"timerCounter",0);i(this,"soundChip");this.interruptEnable=1,this.ioRegisters[0]=207,this.ioRegisters[1]=0,this.ioRegisters[2]=0,this.ioRegisters[4]=0,this.ioRegisters[5]=0,this.ioRegisters[6]=0,this.ioRegisters[7]=0,this.ioRegisters[15]=0,this.ioRegisters[64]=145,this.ioRegisters[65]=0,this.ioRegisters[66]=0,this.ioRegisters[67]=0,this.ioRegisters[68]=0,this.ioRegisters[69]=0,this.ioRegisters[71]=252}read8(t){return t=t&65535,t<32768?this.rom[t]:t<40960?this.vram[t-32768]:t<49152?this.extRam[t-40960]:t<57344?this.workRam[t-49152]:t<65024?this.workRam[t-57344]:t<65184?this.oam[t-65024]:t<65280?255:t<65408?t===65280?this.joypad.readP1():t===65284?this.dividerCounter>>8&255:t===65285?this.ioRegisters[5]:t===65286?this.ioRegisters[6]:t===65287?this.ioRegisters[7]:this.ioRegisters[t-65280]:t<65535?this.highRam[t-65408]:this.interruptEnable}write8(t,e){if(t=t&65535,e=e&255,t>=65296&&t<=65343&&this.soundChip&&this.soundChip.writeRegister(t,e),!(t<32768))if(t<40960)this.vram[t-32768]=e;else if(t<49152)this.extRam[t-40960]=e;else if(t<57344)this.workRam[t-49152]=e;else if(t<65024)this.workRam[t-57344]=e;else if(t<65184)e!==0&&console.log(`OAM write (non-zero): 0x${t.toString(16)} = 0x${e.toString(16)}`),this.oam[t-65024]=e;else{if(t<65280)return;t<65408?(t===65280?this.joypad.writeP1(e):t===65284?this.dividerCounter=0:t===65285?this.ioRegisters[5]=e:t===65286?this.ioRegisters[6]=e:t===65287?this.ioRegisters[7]=e&7:t===65350&&this.handleOAMDMA(e),this.ioRegisters[t-65280]=e):t<65535?this.highRam[t-65408]=e:this.interruptEnable=e}}read16(t){const e=this.read8(t);return this.read8(t+1)<<8|e}write16(t,e){this.write8(t,e&255),this.write8(t+1,e>>8&255)}loadRom(t){const e=Math.min(t.length,this.rom.length);this.rom.set(t.subarray(0,e))}setJoypadButton(t,e){this.joypad.setButton(t,e)}handleOAMDMA(t){const e=t<<8;for(let s=0;s<160;s++){const r=this.read8(e+s);this.oam[s]=r}}updateTimers(t){const e=Math.random()<.1?1:0;this.dividerCounter+=t+e,this.dividerCounter>=65536&&(this.dividerCounter-=65536);const s=this.ioRegisters[7];if((s&4)!==0){const h=this.getTimerFrequency(s&3);for(this.timerCounter+=t;this.timerCounter>=h;){this.timerCounter-=h;let g=this.ioRegisters[5];g++,g>255?(this.ioRegisters[5]=this.ioRegisters[6],this.requestInterrupt(2)):this.ioRegisters[5]=g}}}getTimerFrequency(t){switch(t){case 0:return 1024;case 1:return 16;case 2:return 64;case 3:return 256;default:return 1024}}requestInterrupt(t){const e=this.ioRegisters[15];this.ioRegisters[15]=e|1<<t}}const n=class n{constructor(t){i(this,"screenWidth",160);i(this,"screenHeight",144);i(this,"memory");i(this,"framebuffer");i(this,"_currentLine",0);i(this,"_mode",2);i(this,"_cycles",0);i(this,"_vblankRequested",!1);this.memory=t,this.framebuffer=new Uint8Array(this.screenWidth*this.screenHeight),this.framebuffer.fill(3),this.memory.write8(n.LCD_CONTROL,145),this.memory.write8(n.LCD_STATUS,0),this.memory.write8(n.SCROLL_Y,0),this.memory.write8(n.SCROLL_X,0),this.memory.write8(n.LY,0),this.memory.write8(n.LYC,0)}get currentLine(){return this._currentLine}get mode(){return this._mode}get vblankRequested(){return this._vblankRequested}step(t){this._cycles+=t,this.memory.write8(n.LY,this._currentLine),this._currentLine<144?this.handleVisibleScanline():this.handleVBlankPeriod()}handleVisibleScanline(){this._cycles>=n.SCANLINE_CYCLES?(this._cycles-=n.SCANLINE_CYCLES,this.renderScanline(),this._currentLine++,this._currentLine===144&&(this._mode=1,this._vblankRequested=!0)):this._cycles<n.OAM_SEARCH_CYCLES?this._mode=2:this._cycles<n.OAM_SEARCH_CYCLES+n.PIXEL_TRANSFER_CYCLES?this._mode=3:this._mode=0,this.updateLCDStatus()}handleVBlankPeriod(){this._cycles>=n.SCANLINE_CYCLES&&(this._cycles-=n.SCANLINE_CYCLES,this._currentLine++,this._currentLine>153&&(this._currentLine=0,this._mode=2)),this.updateLCDStatus()}updateLCDStatus(){let t=this.memory.read8(n.LCD_STATUS)&252;t|=this._mode,this._currentLine===this.memory.read8(n.LYC)&&(t|=4),this.memory.write8(n.LCD_STATUS,t)}renderScanline(){const t=this.memory.read8(n.LCD_CONTROL);if(!(t&128)){this.fillScanlineWithColor(0);return}t&1?this.renderBackgroundScanline():this.fillScanlineWithColor(0),t&2&&this.renderSpriteScanline()}renderBackgroundScanline(){const t=this.memory.read8(n.LCD_CONTROL),e=this.memory.read8(n.SCROLL_Y),s=this.memory.read8(n.SCROLL_X),r=t&8?n.TILE_MAP_1:n.TILE_MAP_0,h=(t&16)!==0,g=this._currentLine+e&255,o=g>>3,l=g&7;let c=s>>3,A=s&7,E=r+o*32+c,_=this.memory.read8(E),y=h?n.TILE_DATA_0+_*16:36864+(_>127?_-256:_)*16,b=this.memory.read8(y+l*2),N=this.memory.read8(y+l*2+1);for(let k=0;k<this.screenWidth;k++){A===8&&(c++,A=0,E=r+o*32+c,_=this.memory.read8(E),y=h?n.TILE_DATA_0+_*16:36864+(_>127?_-256:_)*16,b=this.memory.read8(y+l*2),N=this.memory.read8(y+l*2+1));const S=7-A,v=b>>S&1,Y=(N>>S&1)<<1|v;this.framebuffer[this._currentLine*this.screenWidth+k]=Z[Y],A++}}renderSpriteScanline(){const e=this.memory.read8(n.LCD_CONTROL)&4?16:8,s=[];for(let r=0;r<40;r++){const h=65024+r*4,g=this.memory.read8(h),o=this.memory.read8(h+1),l=this.memory.read8(h+2),c=this.memory.read8(h+3),A=g-16,E=o-8;if(this._currentLine>=A&&this._currentLine<A+e&&s.push({x:E,y:A,tileIndex:l,attributes:c,oamIndex:r}),s.length>=10)break}s.sort((r,h)=>r.x===h.x?r.oamIndex-h.oamIndex:r.x-h.x);for(let r=s.length-1;r>=0;r--)this.renderSprite(s[r],e)}renderSprite(t,e){const s=this._currentLine-t.y,r=(t.attributes&32)!==0,h=(t.attributes&64)!==0,g=(t.attributes&128)!==0;let o=h?e-1-s:s,l=t.tileIndex;e===16&&(o>=8?(l=t.tileIndex|1,o-=8):l=t.tileIndex&254);const c=32768+l*16,A=this.memory.read8(c+o*2),E=this.memory.read8(c+o*2+1);for(let _=0;_<8;_++){const y=t.x+_;if(y<0||y>=this.screenWidth)continue;const b=r?_:7-_,N=A>>b&1,S=(E>>b&1)<<1|N;if(S===0)continue;const v=this._currentLine*this.screenWidth+y;g&&this.framebuffer[v]!==0||(this.framebuffer[v]=Z[S&3])}}fillScanlineWithColor(t){const e=this._currentLine*this.screenWidth,s=e+this.screenWidth;this.framebuffer.fill(t,e,s)}getFramebuffer(){return this.framebuffer}clearVBlankRequest(){this._vblankRequested=!1}};i(n,"OAM_SEARCH_CYCLES",80),i(n,"PIXEL_TRANSFER_CYCLES",172),i(n,"SCANLINE_CYCLES",456),i(n,"LCD_CONTROL",65344),i(n,"LCD_STATUS",65345),i(n,"SCROLL_Y",65346),i(n,"SCROLL_X",65347),i(n,"LY",65348),i(n,"LYC",65349),i(n,"TILE_DATA_0",32768),i(n,"TILE_MAP_0",38912),i(n,"TILE_MAP_1",39936);let O=n;const Z=[0,1,2,3],Q=[.125,.25,.5,.75],q=0,V=1,G=2,M=3,x=4;class tt{constructor(){i(this,"registers",new Uint8Array(5));i(this,"enabled",!1);i(this,"lengthCounter",0);i(this,"envelopeVolume",0);i(this,"envelopeTimer",0);i(this,"sweepTimer",0);i(this,"sweepShadowFreq",0)}writeRegister(t,e){const s=t-65296;s<0||s>=this.registers.length||(this.registers[s]=e&255,s===q&&(this.sweepTimer=e>>4&7||8),s===x&&e&128&&this.trigger())}readRegister(t){const e=t-65296;return e<0||e>=this.registers.length?0:this.registers[e]}trigger(){this.enabled=!0,this.lengthCounter=64-(this.registers[V]&63);const t=this.registers[G];this.envelopeVolume=t>>4&15,this.envelopeTimer=t&7||8,this.sweepShadowFreq=(this.registers[x]&7)<<8|this.registers[M],this.sweepTimer=this.registers[q]>>4&7||8}stepSweep(){const t=this.registers[q],e=t>>4&7,s=t&7,r=(t&8)!==0;if(e!==0&&--this.sweepTimer===0&&(this.sweepTimer=e||8,s>0)){let h=this.sweepShadowFreq>>s;r?h=this.sweepShadowFreq-h:h=this.sweepShadowFreq+h,h>2047?this.enabled=!1:(this.sweepShadowFreq=h,this.registers[M]=h&255,this.registers[x]=this.registers[x]&248|h>>8&7)}}stepEnvelope(){const t=this.registers[G],e=t&8?1:-1,s=t&7;if(s&&this.envelopeTimer--===0){this.envelopeTimer=s;let r=this.envelopeVolume+e;r>=0&&r<=15&&(this.envelopeVolume=r)}}stepLength(){this.lengthCounter>0&&(this.lengthCounter--,this.lengthCounter===0&&(this.enabled=!1))}stepFrameSequencer(){this.stepSweep(),this.stepEnvelope(),this.stepLength()}sample(t,e){if(!this.enabled)return 0;let s=this.registers[M],h=(this.registers[x]&7)<<8|s;this.sweepShadowFreq&&(h=this.sweepShadowFreq);const g=h<2048?131072/(2048-h):0;if(g<=0||this.envelopeVolume===0)return 0;const o=e/g,l=this.registers[V]>>6,c=o*Q[l];return(t%o<c?1:-1)*(this.envelopeVolume/15)*.25}}class et{constructor(){i(this,"registers",{});i(this,"enabled",!1);i(this,"lengthCounter",0);i(this,"envelopeVolume",0);i(this,"envelopeTimer",0)}writeRegister(t,e){this.registers[t]=e&255,t===65305&&e&128&&this.trigger()}readRegister(t){return this.registers[t]??0}trigger(){this.enabled=!0,this.lengthCounter=64-(this.registers[65302]??0)&63;const t=this.registers[65303]??0;this.envelopeVolume=t>>4&15,this.envelopeTimer=t&7||8}stepEnvelope(){const t=this.registers[65303]??0,e=t&8?1:-1,s=t&7;if(s&&this.envelopeTimer--===0){this.envelopeTimer=s;let r=this.envelopeVolume+e;r>=0&&r<=15&&(this.envelopeVolume=r)}}stepLength(){this.lengthCounter>0&&(this.lengthCounter--,this.lengthCounter===0&&(this.enabled=!1))}stepFrameSequencer(){this.stepEnvelope(),this.stepLength()}sample(t,e){if(!this.enabled)return 0;const s=this.envelopeVolume,r=this.registers[65304]??0,g=((this.registers[65305]??0)&7)<<8|r,o=g<2048?131072/(2048-g):0;if(o<=0||s===0)return 0;const l=e/o,c=(this.registers[65302]??0)>>6,E=l*[.125,.25,.5,.75][c];return(t%l<E?1:-1)*(s/15)*.25}}class st{constructor(){i(this,"registers",{});i(this,"enabled",!1);i(this,"lengthCounter",0);i(this,"volumeShift",0);i(this,"waveTable",new Uint8Array(32))}writeRegister(t,e){if(this.registers[t]=e&255,t===65306&&(this.enabled=!!(e&128)),t===65310&&e&128&&this.trigger(),t>=65328&&t<=65343){const s=t-65328;this.waveTable[s*2]=e>>4&15,this.waveTable[s*2+1]=e&15}}readRegister(t){return this.registers[t]??0}trigger(){this.enabled=!0,this.lengthCounter=256-(this.registers[65307]??0),this.volumeShift=(this.registers[65308]??0)>>5&3}stepLength(){this.lengthCounter>0&&(this.lengthCounter--,this.lengthCounter===0&&(this.enabled=!1))}stepFrameSequencer(){this.stepLength()}sample(t,e){if(!this.enabled)return 0;const s=this.registers[65309]??0,h=((this.registers[65310]??0)&7)<<8|s,g=h<2048?2097152/(2048-h)/2:0;if(g<=0)return 0;const o=e/g,l=Math.floor(t/o%32);let c=this.waveTable[l]??0;return this.volumeShift===0?c=0:this.volumeShift===2?c>>=1:this.volumeShift===3&&(c>>=2),(c/15-.5)*.5}}class rt{constructor(){i(this,"registers",{});i(this,"enabled",!1);i(this,"lengthCounter",0);i(this,"envelopeVolume",0);i(this,"envelopeTimer",0);i(this,"lfsr",32767)}writeRegister(t,e){this.registers[t]=e&255,t===65315&&e&128&&this.trigger()}readRegister(t){return this.registers[t]??0}trigger(){this.enabled=!0,this.lengthCounter=64-(this.registers[65312]??0)&63;const t=this.registers[65313]??0;this.envelopeVolume=t>>4&15,this.envelopeTimer=t&7||8,this.lfsr=32767}stepEnvelope(){const t=this.registers[65313]??0,e=t&8?1:-1,s=t&7;if(s&&this.envelopeTimer--===0){this.envelopeTimer=s;let r=this.envelopeVolume+e;r>=0&&r<=15&&(this.envelopeVolume=r)}}stepLength(){this.lengthCounter>0&&(this.lengthCounter--,this.lengthCounter===0&&(this.enabled=!1))}stepFrameSequencer(){this.stepEnvelope(),this.stepLength()}sample(t,e){if(!this.enabled)return 0;const s=this.registers[65314]??0,r=s&7,h=s>>4&15,g=(s&8)!==0,l=524288/(r===0?.5:r*2)/(1<<h+1);if(l<=0||this.envelopeVolume===0)return 0;if(t%Math.floor(e/l)===0){let A=(this.lfsr^this.lfsr>>1)&1;this.lfsr=this.lfsr>>1|A<<14,g&&(this.lfsr=this.lfsr&-65|A<<6)}return(~this.lfsr&1?1:-1)*(this.envelopeVolume/15)*.25}}class it{constructor(){i(this,"channel1");i(this,"channel2");i(this,"channel3");i(this,"channel4");i(this,"globalRegisters",{});i(this,"audioCtx",null);i(this,"scriptNode",null);i(this,"sampleRate",48e3);i(this,"bufferSize",256);i(this,"frameSeqCounter",0);i(this,"channelPhases",[0,0,0,0]);i(this,"prevFilteredSample",0);this.channel1=new tt,this.channel2=new et,this.channel3=new st,this.channel4=new rt}writeRegister(t,e){if(t>=65296&&t<=65300){this.channel1.writeRegister(t,e);return}if(t>=65302&&t<=65305){this.channel2.writeRegister(t,e);return}if(t>=65306&&t<=65310){this.channel3.writeRegister(t,e);return}if(t>=65312&&t<=65315){this.channel4.writeRegister(t,e);return}if(t>=65316&&t<=65318){this.globalRegisters[t]=e&255;return}}readRegister(t){return t>=65316&&t<=65318?this.globalRegisters[t]??0:0}startAudio(){this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:this.sampleRate}),this.scriptNode=this.audioCtx.createScriptProcessor(this.bufferSize,0,1),this.prevFilteredSample=0,this.scriptNode.onaudioprocess=t=>{const e=t.outputBuffer.getChannelData(0),s=.25;for(let r=0;r<e.length;r++){++this.frameSeqCounter>=this.sampleRate/512&&(this.channel1.stepFrameSequencer(),this.channel2.stepFrameSequencer(),this.channel3.stepFrameSequencer(),this.channel4.stepFrameSequencer(),this.frameSeqCounter=0);let h=0;h+=this.channel1.sample(this.channelPhases[0],this.sampleRate),h+=this.channel2.sample(this.channelPhases[1],this.sampleRate),h+=this.channel3.sample(this.channelPhases[2],this.sampleRate),h+=this.channel4.sample(this.channelPhases[3],this.sampleRate),this.prevFilteredSample=s*h+(1-s)*this.prevFilteredSample,e[r]=this.prevFilteredSample,this.channelPhases[0]++,this.channelPhases[1]++,this.channelPhases[2]++,this.channelPhases[3]++}},this.scriptNode.connect(this.audioCtx.destination))}stopAudio(){this.scriptNode&&this.scriptNode.disconnect(),this.audioCtx&&this.audioCtx.close(),this.audioCtx=null,this.scriptNode=null}}const F=class F{constructor(){i(this,"cpu");i(this,"memory");i(this,"ppu");i(this,"soundChip");i(this,"_totalCycles",0);i(this,"_isRunning",!1);this.memory=new J,this.soundChip=new it,this.memory.soundChip=this.soundChip,this.cpu=new X(this.memory),this.ppu=new O(this.memory)}get totalCycles(){return this._totalCycles}get isRunning(){return this._isRunning}loadRom(t){this.memory.loadRom(t),this.memory.write8(65285,0),this.memory.write8(65286,0),this.memory.write8(65287,0),this.memory.write8(65296,128),this.memory.write8(65297,191),this.memory.write8(65298,243),this.memory.write8(65300,191),this.memory.write8(65302,63),this.memory.write8(65303,0),this.memory.write8(65305,191),this.memory.write8(65306,127),this.memory.write8(65307,255),this.memory.write8(65308,159),this.memory.write8(65310,191),this.memory.write8(65312,255),this.memory.write8(65313,0),this.memory.write8(65314,0),this.memory.write8(65315,191),this.memory.write8(65316,119),this.memory.write8(65317,243),this.memory.write8(65318,241),this.memory.write8(65344,147),this.memory.write8(65346,0),this.memory.write8(65347,0),this.memory.write8(65349,0),this.memory.write8(65351,252),this.memory.write8(65352,255),this.memory.write8(65353,255),this.memory.write8(65354,0),this.memory.write8(65355,0),this.memory.write8(65535,0),this.cpu.registers.AF=432,this.cpu.registers.BC=19,this.cpu.registers.DE=216,this.cpu.registers.HL=333,this.cpu.registers.SP=65534,this.cpu.registers.PC=256}step(){if(this.cpu.isHalted)this.ppu.step(4),this.memory.updateTimers(4),this._totalCycles+=4;else{const t=this.cpu.totalCycles;this.cpu.step();const e=this.cpu.totalCycles-t;this.ppu.step(e),this.memory.updateTimers(e),this._totalCycles+=e}this.updateInterruptFlags()}runFrame(){const t=this._totalCycles,e=t+F.CYCLES_PER_FRAME;for(;this._totalCycles<e;)if(this.step(),this._totalCycles-t>F.CYCLES_PER_FRAME*2){console.warn("Frame took too long, breaking out");break}}start(){this._isRunning=!0}stop(){this._isRunning=!1}reset(){this._totalCycles=0,this._isRunning=!1}updateInterruptFlags(){if(this.ppu.vblankRequested){const t=this.memory.read8(65295);this.memory.write8(65295,t|1),this.ppu.clearVBlankRequest()}this.ensureLCDConfigured()}ensureLCDConfigured(){!(this.memory.read8(65344)&128)&&this._totalCycles>1e5&&(this.memory.write8(65344,145),this.memory.write8(65351,252))}getScreenData(){return this.ppu.getFramebuffer()}setJoypadButton(t,e){this.memory.setJoypadButton(t,e)}getStats(){return{totalCycles:this._totalCycles,cpuCycles:this.cpu.totalCycles,currentScanline:this.ppu.currentLine,ppuMode:this.ppu.mode,isRunning:this._isRunning}}};i(F,"CYCLES_PER_FRAME",70224);let W=F;class ht{constructor(){i(this,"gameboy");i(this,"canvas");i(this,"ctx");i(this,"isRunning",!1);i(this,"animationId");i(this,"lastFrameTime",0);i(this,"SCREEN_WIDTH",160);i(this,"SCREEN_HEIGHT",144);i(this,"SCALE",2);i(this,"TARGET_FPS",60);i(this,"FRAME_TIME",1e3/this.TARGET_FPS);if(this.canvas=document.getElementById("gameboy-screen"),!this.canvas)throw new Error("Canvas element not found");const t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get 2D context from canvas");this.ctx=t,this.canvas.width=this.SCREEN_WIDTH,this.canvas.height=this.SCREEN_HEIGHT,this.canvas.style.width=`${this.SCREEN_WIDTH*this.SCALE}px`,this.canvas.style.height=`${this.SCREEN_HEIGHT*this.SCALE}px`,this.canvas.tabIndex=0,this.canvas.focus(),this.gameboy=new W,this.setupUI(),this.initializeDisplay(),console.log("Game Boy Emulator initialized!")}setupUI(){const t=document.getElementById("load-game"),e=document.getElementById("start"),s=document.getElementById("pause"),r=document.getElementById("reset"),h=document.getElementById("start-audio"),g=document.getElementById("fullscreen");t?.addEventListener("click",()=>this.loadROM("/vibe-gameboy-emulator/blocks.gb","Block Puzzle Game")),e?.addEventListener("click",()=>this.start()),s?.addEventListener("click",()=>this.pause()),r?.addEventListener("click",()=>this.reset()),h?.addEventListener("click",()=>{this.gameboy.soundChip.startAudio()}),g?.addEventListener("click",()=>this.enterFullscreen()),document.addEventListener("keydown",o=>this.handleKeyDown(o)),document.addEventListener("keyup",o=>this.handleKeyUp(o)),this.canvas.addEventListener("click",()=>{this.canvas.focus()})}initializeDisplay(){this.ctx.fillStyle="#9bbc0f",this.ctx.fillRect(0,0,this.SCREEN_WIDTH,this.SCREEN_HEIGHT),this.ctx.fillStyle="#0f380f",this.ctx.font="8px monospace",this.ctx.textAlign="center",this.ctx.fillText("Game Boy Emulator",this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2-10),this.ctx.fillText('Press "Load ROM" to start',this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2+10)}async loadROM(t,e){try{const s=await fetch(t);if(!s.ok)throw new Error(`Failed to load ROM: ${s.statusText}`);const r=new Uint8Array(await s.arrayBuffer());this.gameboy.loadRom(r),console.log(`${e} ROM loaded successfully!`),console.log(`ROM size: ${r.length} bytes`),this.ctx.fillStyle="#9bbc0f",this.ctx.fillRect(0,0,this.SCREEN_WIDTH,this.SCREEN_HEIGHT),this.ctx.fillStyle="#0f380f",this.ctx.font="8px monospace",this.ctx.textAlign="center",this.ctx.fillText(`${e} ROM Loaded!`,this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2-10),this.ctx.fillText('Press "Start" to begin',this.SCREEN_WIDTH/2,this.SCREEN_HEIGHT/2+10)}catch(s){console.error("Failed to load ROM:",s),alert(`Failed to load ${e} ROM. Make sure ${t} is in the public directory.`)}}start(){this.isRunning||(this.isRunning=!0,console.log("Starting emulation..."),this.emulationLoop())}pause(){this.isRunning=!1,this.animationId&&cancelAnimationFrame(this.animationId),console.log("Emulation paused")}reset(){this.pause(),this.gameboy=new W,this.initializeDisplay(),console.log("Emulator reset")}emulationLoop(){if(!this.isRunning)return;const t=performance.now();if(t-this.lastFrameTime>=this.FRAME_TIME){this.lastFrameTime=t;try{this.gameboy.runFrame(),this.renderFrame()}catch(s){console.error("Emulation error:",s),this.pause();return}}this.animationId=requestAnimationFrame(()=>this.emulationLoop())}renderFrame(){const t=this.gameboy.getScreenData(),e=this.ctx.createImageData(this.SCREEN_WIDTH,this.SCREEN_HEIGHT),s=[[155,188,15,255],[139,172,15,255],[48,98,48,255],[15,56,15,255]];for(let r=0;r<t.length;r++){const h=t[r]&3,g=s[h],o=r*4;e.data[o]=g[0],e.data[o+1]=g[1],e.data[o+2]=g[2],e.data[o+3]=g[3]}this.ctx.putImageData(e,0,0)}handleKeyDown(t){const s={ArrowUp:"Up",ArrowDown:"Down",ArrowLeft:"Left",ArrowRight:"Right",KeyZ:"A",KeyX:"B",Enter:"Start",Backspace:"Select"}[t.code];s&&(this.gameboy.setJoypadButton(s,!0),t.preventDefault())}handleKeyUp(t){const s={ArrowUp:"Up",ArrowDown:"Down",ArrowLeft:"Left",ArrowRight:"Right",KeyZ:"A",KeyX:"B",Enter:"Start",Backspace:"Select"}[t.code];s&&(this.gameboy.setJoypadButton(s,!1),t.preventDefault())}enterFullscreen(){const t=this.canvas.parentElement||this.canvas;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(),document.addEventListener("fullscreenchange",()=>this.resizeCanvasForFullscreen()),document.addEventListener("webkitfullscreenchange",()=>this.resizeCanvasForFullscreen())}resizeCanvasForFullscreen(){if(document.fullscreenElement||document.webkitFullscreenElement){const e=window.innerWidth,s=window.innerHeight,r=this.SCREEN_WIDTH/this.SCREEN_HEIGHT;let h=e,g=Math.round(h/r);g>s&&(g=s,h=Math.round(g*r)),this.canvas.style.width=h+"px",this.canvas.style.height=g+"px"}else this.canvas.style.width=this.SCREEN_WIDTH*this.SCALE+"px",this.canvas.style.height=this.SCREEN_HEIGHT*this.SCALE+"px"}}document.addEventListener("DOMContentLoaded",()=>{new ht});
